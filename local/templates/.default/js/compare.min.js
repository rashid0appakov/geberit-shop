"use strict";
var CP = CP || {},
    _arTmp = [];
CP.Main = {
    vars: {},
    setEventsAddToCompareList: function() {
        if ($(".buy__item-diff, .icon-diff-big[data-id]").length) {
            $(".buy__item-diff, .icon-diff-big[data-id]").click(function(a) {
                a.preventDefault();
                if ($(this).hasClass("compare-added")) {
                    location.href = "/compare/"
                } else {
                    CP.addToCompareList($(this))
                }
            })
        }
    },
    setEventDeleteCompareItem: function() {
        if ($("a.delete-compare-item").length) {
            $("a.delete-compare-item").click(function() {
                BX.addCustomEvent(window, "onCatalogDeleteCompare", BX.proxy(CP.removeCompareCookie($(this).data("id")), this))
            })
        }
    },
    addToCompareList: function(a, type = false) {

        if (a == undefined) {
            return false
        }
        if (!a.data("id") || !SC.vars.send) {
            return false
        }
        a.addClass("added-wait");
        SC.ajaxSendPost("/ajax/?action=ADD_TO_COMPARE_LIST&id=" + a.data("id"), {
            method: "compare"
        }, function(b) {
            SC.vars.send = true;
            BX.closeWait("", SC.vars.wait);
            if (b.status == "success") {
                if ($(".added-wait").length) {
                    $(".added-wait").addClass("compare-added");
                    if ($(".added-wait").find(".buy__item-diff-link").length) {
                        $(".added-wait").removeClass("added-wait").addClass("compare-added").find(".buy__item-diff-link").text($(".compare-item-button").data("added"))
                    } else {
                        $(".added-wait").removeClass("added-wait").attr("data-tooltip", $(".compare-item-button").data("added"))
                    }
                    CP.addToCompareCookie(b.id)
                }
                CP.updateCompareLine(type)
            } else {
                console.log(b)
            }
        }, "json")
    },
    updateCompareLine: function(type) {
        SC.ajaxSendPost("/ajax/compare_line2.php", {}, function(a) {
            SC.vars.send = true;
            BX.closeWait("", SC.vars.wait);
            $(".diff .tag").html(a.qty);
            if (a.qty) {
                $(".compare-item-button").addClass("compare-added")
            } else {
                $(".compare-item-button").removeClass("compare-added")
            }
			
			if(type == 'viewed'){
				SC.addToCompareListPageViewed();
			}
			
        }, "json")
    },
    addToCompareCookie: function(a) {
        if (a == undefined || !a) {
            return false
        }
        _arTmp = [];
        if ($.cookie("COMPARE_LIST")) {
            _arTmp = $.cookie("COMPARE_LIST").split(",")
        }
        _arTmp[_arTmp.length] = a;
        $.cookie("COMPARE_LIST", _arTmp.join(","), {
            path: "/",
            expires: 3
        })
    },
    removeCompareCookie: function(a) {
        if (a == undefined || !a) {
            $.cookie("COMPARE_LIST", "", {
                path: "/",
                expires: 0
            });
            return true
        }
        _arTmp = [];
        if ($.cookie("COMPARE_LIST")) {
            _arTmp = $.cookie("COMPARE_LIST").split(",")
        }
        $.each(_arTmp, function(c, b) {
            if (b == a) {
                _arTmp.splice(c, 1)
            }
        });
        $.cookie("COMPARE_LIST", (_arTmp.length ? _arTmp.join(",") : ""), {
            path: "/",
            expires: _arTmp.length ? 3 : 0
        });
        _timer = setTimeout("CP.updateCompareLine();", 1000)
    },
    checkCompareItems: function() {
        $(".buy__item-diff, .icon-diff-big[data-id]").removeClass("compare-added");
        if ($.cookie("COMPARE_LIST")) {
            _arTmp = $.cookie("COMPARE_LIST").split(",")
        }
        $.each(_arTmp, function(b, a) {
            $(".buy__item-diff[data-id=" + a + "], .icon-diff-big[data-id=" + a + "]").addClass("compare-added").attr("data-tooltip", $(".compare-item-button").data("added"));
            if ($(".buy__item-diff[data-id=" + a + "]").length) {
                $(".buy__item-diff[data-id=" + a + "]").find(".buy__item-diff-link").text($(".compare-item-button").data("added"))
            }
        })
    },
    init: function() {
        var a = CP.Main;
        $(function() {
            _timer = setTimeout("CP.setEventsAddToCompareList();", 1500);
            a.checkCompareItems()
        });
        return a
    }
};
CP = CP.Main.init();