(function(a){if(!!a.JSGeolocationSelectPopup){return}a.JSGeolocationSelectPopup=function(b){this.params=null;this.inputSelector=null;this.containerSelector=null;this.ajaxUrl=null;this.storeCity=null;this.deliveryCity=null;this.images=null;this.timeoutTime=300;this.timeout=null;if(typeof b==="object"){this.params=b.params;this.inputSelector=b.inputSelector;this.containerSelector=b.containerSelector;this.ajaxUrl=b.ajaxUrl;this.storeCity=b.storeCity;this.deliveryCity=b.deliveryCity;this.images=b.images;this.defaultCity=b.defaultCity}$($.proxy(this.Init,this))};a.JSGeolocationSelectPopup.prototype.GetInput=function(){return $(this.inputSelector)};a.JSGeolocationSelectPopup.prototype.GetContainer=function(){return $(this.containerSelector)};a.JSGeolocationSelectPopup.prototype.Init=function(){this.GetInput().on("input",$.proxy(this.OnInputChanged,this));this.SetDefaultCity()};a.JSGeolocationSelectPopup.prototype.OnInputChanged=function(){if(!!this.timeout){a.clearTimeout(this.timeout)}this.timeout=a.setTimeout($.proxy(this.OnInputTimeout,this),this.timeoutTime)};a.JSGeolocationSelectPopup.prototype.OnInputTimeout=function(){var b=this.GetInput().val();if(b.length>=3){this.SendSearchAjax(b)}};a.JSGeolocationSelectPopup.prototype.SendSearchAjax=function(b){$.ajax({url:this.ajaxUrl,method:"POST",dataType:"json",data:{action:"search",params:this.params,sessid:BX.bitrix_sessid(),text:b},success:$.proxy(this.OnSearchAjaxSuccess,this),error:$.proxy(this.OnSearchAjaxError,this)})};a.JSGeolocationSelectPopup.prototype.OnSearchAjaxSuccess=function(c,d,b){if(!c.error){this.SetItems(c.items)}};a.JSGeolocationSelectPopup.prototype.OnSearchAjaxError=function(b,d,c){};a.JSGeolocationSelectPopup.prototype.SetItems=function(c){var b=this.GetContainer();b.children().remove();if(c!=undefined){c.forEach($.proxy(this.AddItem,this))}};a.JSGeolocationSelectPopup.prototype.AddItem=function(g){var c=this.GetContainer();var f=$("<span/>");c.append(f);f.addClass("city");var e=this.storeCity.indexOf(g.ID)!==-1;var h=this.deliveryCity.indexOf(g.ID)!==-1;if(e||h){f.addClass("mark")}var b=$("<a/>");f.append(b);b.text(g.NAME);b.attr("title",g.PATH);b.attr("data-id",g.ID);b.on("click",$.proxy(this.OnItemClick,this));if(e){var d=$("<img/>");f.append(" ",d);d.attr("src",this.images.store)}if(h){var d=$("<img/>");f.append(" ",d);d.attr("src",this.images.delivery)}};a.JSGeolocationSelectPopup.prototype.OnItemClick=function(c){var b=$(c.target);var d=b.attr("data-id");this.SendSelectAjax(d)};a.JSGeolocationSelectPopup.prototype.SendSelectAjax=function(b){$.ajax({url:this.ajaxUrl,method:"POST",dataType:"json",data:{action:"select",params:this.params,sessid:BX.bitrix_sessid(),id:b},success:$.proxy(this.OnSelectAjaxSuccess,this),error:$.proxy(this.OnSelectAjaxError,this)})};a.JSGeolocationSelectPopup.prototype.OnSelectAjaxSuccess=function(d,g,c){if(!d.error){$("#ajax-input-city").text(d.locationData.CITY_NAME);$("#ajax-input-region").text(d.locationData.REGION_NAME);$("#location_id").val(d.locationData.ID);var e=new Date().getTime();var b=a.location.pathname+"?rand="+e;$.get(b,function(h){$(h).find(".custom-live-ajax-update").each(function(){var i=$(this).attr("id");$("#"+i).html($(this).html());console.log("Update Block ID "+i)});$("#delivery_container").html(JSON.parse(atob($(h).find("#delivery_container-data").data("encode-json"))))});var f={};if(f.toString.call("customDeliveryClick")==="[object Function]"){customDeliveryClick()}$("#close-modal-region").trigger("click");if(typeof SOA=="object"){SOA.getDeliveryServices()}}};a.JSGeolocationSelectPopup.prototype.OnSelectAjaxError=function(b,d,c){};a.JSGeolocationSelectPopup.prototype.SetDefaultCity=function(){this.SetItems(this.defaultCity)}})(window);